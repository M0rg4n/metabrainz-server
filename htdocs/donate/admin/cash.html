%# vi: set ts=2 sw=2 ft=mason :
<%args>
$first_name=>''
$last_name=>''
$email=>''
$moderator=>''
$contact=>''
$anon=>''
$address_street=>''
$address_city=>''
$address_state=>''
$address_postcode=>''
$address_country=>''
$payment_date=>''
$amount=>''
$fee=>''
$memo=>''
$submit=>''
</%args>
<%perl>

my $anon_checked_no = ' checked=""'; 
my $anon_checked_yes = '';
if ($anon eq 'no')
{
    $anon_checked_yes = '';
    $anon_checked_no = ' checked=""'; 
}
my $contact_checked_yes = ' checked=""'; 
my $contact_checked_no = '';
if ($contact eq 'no')
{
    $contact_checked_yes = '';
    $contact_checked_no = ' checked=""'; 
}

if ($first_name =~ /\S/ 
    && $last_name =~ /\S/
    && $email =~ /\S/
    && $contact =~ /\S/
    && $address_street =~ /\S/
    && $address_city =~ /\S/
    && $address_state =~ /\S/
    && $address_postcode =~ /\S/
    && $address_country =~ /\S/
    && $amount =~ /\S/
   )
{
    require MetaBrainz::Server::Donation;

    my $mb = new MetaBrainz::Server::MetaBrainz(1);
    $mb->Login();
    my $don = MetaBrainz::Server::Donation->new($mb->{DBH});

    my %data = %ARGS;

    $data{fee} = "0.00" if (!($data{fee}));

    my $err = $don->Insert(%data);
    if ($err)
    {
        $m->comp("/comp/sidebar", title=>'Error', expand=>'finances');
        $m->out("<p>A new donation could not be entered due to this error:</p>");
        $m->out("<blockquote><b>$err</b></blockquote>");
    }
    else
    {
        $m->comp("/comp/sidebar", title=>'Cash donation entered', expand=>'finances');
        $m->out("<p>A new donation was entered and a receipt was mailed!</p>");
        $m->comp("/comp/footer");

        require MetaBrainz::Server::Receipt;
        my $rec = MetaBrainz::Server::Receipt->new();
        $rec->MailReceipt($don->GetId()); 
        
        return;
    }
}
else
{
    $m->comp("/comp/sidebar", title=>'Enter cash donation', expand=>'finances');
    if ($submit) 
    {
        $m->out('<p><span style="color: red;">Error:</span> Some required fields are missing!</p>');
    }
}

</%perl>

<p>
To enter a cash donation, fill out the fields below:
</p>

<form method="post" action="cash.html" name="CashDontionForm">   
<table>
<tr>
   <td align="right" valign="top">Name (first, last):</td>
   <td>
   <input type="text" size="20" name="first_name" value="<% $first_name %>">
   <input type="text" size="20" name="last_name" value="<% $last_name %>"> */*
   </td>
</tr>
<tr>
   <td align="right" valign="top">Email:</td>
   <td>
   <input type="text" size="30" name="email" value="<% $email %>"> *
   </td>
</tr>
<tr>
   <td align="right" valign="top">Can contact?</td>
   <td>
    Yes <input type="radio" name="contact" value="yes" <% $contact_checked_yes %>>
    No <input type="radio" name="contact" value="no"<% $contact_checked_no %>>&nbsp;&nbsp;</nobr>
   </td>
</tr>
<tr>
   <td align="right" valign="top">Anon donation?</td>
   <td>
    Yes <input type="radio" name="anon" value="yes"<% $anon_checked_yes %>>
    No <input type="radio" name="anon" value="no"<% $anon_checked_no %>>&nbsp;&nbsp;</nobr> 
   </td>
</tr>
<tr>
   <td align="right" valign="top">Street:</td>
   <td>
   <input type="text" size="30" name="address_street" value="<% $address_street %>"> *
   </td>
</tr>
<tr>
   <td align="right" valign="top">City/State/ZIP:</td>
   <td>
   <input type="text" size="20" name="address_city" value="<% $address_city %>"> 
   <input type="text" size="16" name="address_state" value="<% $address_state %>"> 
   <input type="text" size="10" name="address_postcode" value="<% $address_postcode %>"> *
   </td>
</tr>
<tr>
   <td align="right" valign="top">Country:</td>
   <td>
   <input type="text" size="20" name="address_country" value="<% $address_country %>"> *
   </td>
</tr>
<tr>
   <td align="right" valign="top">Payment date:</td>
   <td>
   <input type="text" size="10" name="payment_date" value="<% $payment_date %>"> (MM-DD-YYYY or leave blank for NOW)
   </td>
</tr>
<tr>
   <td align="right" valign="top">Net donation amount:</td>
   <td>
   <input type="text" size="10" name="amount" value="<% $amount %>"> USD *
   </td>
</tr>
<tr>
   <td align="right" valign="top">Fee:</td>
   <td>
   <input type="text" size="10" name="fee" value="<% $fee %>"> USD
   </td>
</tr>
<tr>
   <td align="right" valign="top">Memo:</td>
   <td>
      <textarea name="memo" rows="4" cols="40"><% $memo %></textarea>
   </td>
</tr>
<tr>
   <td align="right" valign="top">&nbsp;</td>
   <td>
      &nbsp;<input type="hidden" name="submit" value="1">
   </td>
</tr>
<tr>
   <td align="right" valign="top">&nbsp;</td>
   <td>
      <input type="submit" value="Enter cash donation">
   </td>
</tr>
</table>
</form>
<p>
(Fields marked with * are required)
</p>

<& /comp/movefocus, "CashDonationForm", "linktypename" &>
<& /comp/footer &>
